<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clue Master: 4-Team Pass & Play</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'team1': '#4F46E5', // Indigo (Primary)
                        'team2': '#10B981', // Emerald (Secondary)
                        'team3': '#F59E0B', // Amber
                        'team4': '#EF4444', // Red
                        'accent': '#6366F1', // Indigo-500 for general use
                        'background': '#F9FAFB', // Light Gray
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Load words.js data file. This must be present in the same directory. -->
    <script src="words.js"></script>

    <style>
        /* Custom styles for better mobile appearance */
        body {
            background-color: #F9FAFB;
        }
        .screen-container {
            transition: opacity 0.3s ease-in-out;
        }
        .game-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .game-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .timer-text {
            font-variant-numeric: tabular-nums;
        }
        .team-color-border-team1 { border-color: #4F46E5; }
        .team-color-border-team2 { border-color: #10B981; }
        .team-color-border-team3 { border-color: #F59E0B; }
        .team-color-border-team4 { border-color: #EF4444; }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-lg bg-white rounded-2xl shadow-2xl p-6 md:p-8">

        <!-- Header: Dynamic Scoreboard and Timer -->
        <div id="header" class="mb-6">
            <!-- Dynamic Scoreboard will be inserted here -->
            <div id="scoreboard" class="grid grid-cols-2 sm:flex sm:justify-around gap-4 mb-4">
                <!-- Scores are populated by JS -->
            </div>
            <div class="text-center p-3 bg-gray-100 rounded-xl shadow-inner">
                <p class="text-xs font-semibold uppercase text-gray-500">Time Left</p>
                <p id="timerDisplay" class="text-4xl font-extrabold text-red-500 timer-text">30</p>
            </div>
        </div>

        <!-- --- Screen Management --- -->

        <!-- 1. Team Setup Screen -->
        <div id="teamSetupScreen" class="screen-container text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Setup Game</h1>
            <p class="text-gray-600 mb-6">Choose your teams and names.</p>
            
            <div class="mb-6 text-left">
                <label for="teamCount" class="block text-sm font-medium text-gray-700 mb-2">Number of Teams:</label>
                <select id="teamCount" onchange="generateTeamNameInputs()" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-accent focus:border-accent">
                    <option value="2">2 Teams</option>
                    <option value="3">3 Teams</option>
                    <option value="4">4 Teams</option>
                </select>
            </div>

            <div id="teamNameInputs" class="space-y-4 mb-8">
                <!-- Team name inputs are generated here -->
            </div>

            <button id="setupStartButton" class="w-full game-button bg-primary hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Ready to Play
            </button>
        </div>

        <!-- 2. Turn Start Screen (Transition) -->
        <div id="turnStartScreen" class="screen-container text-center hidden">
            <h2 id="turnStartTitle" class="text-3xl font-extrabold text-gray-800 mb-2"></h2>
            <p id="turnStartCategory" class="text-lg font-semibold text-accent mb-6"></p>
            <p class="text-gray-600 mb-8">Pass the device to the guesser. Get ready for 30 seconds!</p>
            <button onclick="startTimer()" class="w-full game-button bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl">
                Start Turn
            </button>
        </div>

        <!-- 3. Game Screen -->
        <div id="gameScreen" class="screen-container text-center hidden">
            <p id="categoryLabel" class="text-sm font-semibold uppercase text-accent mb-4">Category: </p>
            <div class="h-32 flex items-center justify-center mb-6">
                <p id="currentWordDisplay" class="text-5xl font-black text-gray-900 break-words max-w-full">WORD</p>
            </div>

            <div id="hintBox" class="bg-gray-100 p-3 rounded-lg text-gray-600 text-sm italic mb-6 hidden">
                <p id="hintText"></p>
                <p class="text-xs mt-1 text-gray-500">Hint used! (<span id="hintsRemaining">2</span> remaining)</p>
            </div>

            <div class="flex space-x-3 mb-6">
                <button id="hintButton" onclick="showHint()" class="flex-1 game-button bg-team3 hover:bg-amber-600 text-white font-bold py-3 px-2 rounded-xl text-sm md:text-base">
                    Hint (<span id="hintsRemainingDisplay">2</span>)
                </button>
            </div>

            <div class="flex space-x-3">
                <button onclick="handleAction('skip')" class="flex-1 game-button bg-team4 hover:bg-red-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Skip (<span id="skipScoreChange">0</span>)
                </button>
                <button id="correctButton" onclick="handleAction('correct')" class="flex-1 game-button bg-primary hover:bg-indigo-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Correct (+1)
                </button>
            </div>
            <p id="skipCounter" class="text-xs text-gray-500 mt-2">Skips used this turn: 0</p>
        </div>

        <!-- 4. Turn End/Results Screen -->
        <div id="turnEndScreen" class="screen-container text-center hidden">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Turn Over!</h2>
            <p id="turnSummary" class="text-lg text-gray-600 mb-6"></p>
            <p id="nextTurnInfo" class="text-sm font-semibold text-gray-500 mb-8"></p>

            <button onclick="nextTurn()" class="w-full game-button bg-accent hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Continue
            </button>
        </div>

        <!-- 5. Game Over Screen -->
        <div id="gameOverScreen" class="screen-container text-center hidden">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-4">Game Over!</h2>
            <p id="winnerMessage" class="text-2xl font-semibold text-secondary mb-6"></p>
            <div id="finalScoreboard" class="flex flex-wrap justify-around mb-8 p-4 bg-gray-100 rounded-lg">
                <!-- Final scores are populated by JS -->
            </div>
            <button onclick="window.location.reload()" class="w-full game-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl">
                Play Again
            </button>
        </div>

    </div>

    <!-- Error/Alert Box (Replaces alert()) -->
    <div id="errorBox" class="w-full max-w-lg mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-lg hidden">
        <p class="font-bold">Error Loading Game Data:</p>
        <p id="errorMessage"></p>
    </div>

    <!-- JavaScript Game Logic -->
    <script type="module">
        // --- Firebase/Firestore Setup (Boilerplate) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let auth = null;
        let db = null;
        let userId = 'anonymous'; 

        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Custom Auth Failed:", e));
                        } else {
                            signInAnonymously(auth).catch(e => console.error("Anonymous Sign In Failed:", e));
                        }
                    }
                });
                setLogLevel('debug');
            } catch (e) {
                console.warn("Firebase initialization failed:", e.message, "Continuing with local game state.");
            }
        }
        // --- End of Firebase/Firestore Setup ---

        // --- Game State (Refactored for dynamic teams) ---
        let gameState = {
            teams: [], // [{name: '...', score: 0, turnsLeft: 3, colorClass: '...'}, ...]
            teamColorClasses: ['team1', 'team2', 'team3', 'team4'],
            currentTeamIndex: 0, 
            isTurnActive: false,
            timer: 30,
            currentCategory: null,
            currentWords: [],
            currentWordIndex: -1,
            currentWord: null,
            skippedWordsInTurn: 0,
            hintsUsedInTurn: 0,
            timerInterval: null,
            currentTurnPoints: 0,
        };

        // --- Utility Functions ---

        /** Hides all game screens and shows the specified one. */
        function showScreen(screenId) {
            ['teamSetupScreen', 'turnStartScreen', 'gameScreen', 'turnEndScreen', 'gameOverScreen'].forEach(id => {
                const screen = document.getElementById(id);
                if (screen) screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');
        }

        /** Updates the dynamic scoreboard in the header. */
        function updateScoreDisplay() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = ''; // Clear existing scores

            gameState.teams.forEach((team, index) => {
                const isCurrent = index === gameState.currentTeamIndex && gameState.isTurnActive;
                
                const scoreElement = document.createElement('div');
                scoreElement.className = `text-center p-2 rounded-xl border-2 transition-all duration-300 ${isCurrent ? 'shadow-lg scale-105' : 'bg-gray-50 border-gray-100'} team-color-border-${team.colorClass}`;
                
                // Use a default name if not set
                const teamName = team.name || `Team ${index + 1}`; 

                scoreElement.innerHTML = `
                    <p class="text-xs font-semibold uppercase text-gray-500 truncate">${teamName}</p>
                    <p class="text-xl font-black text-${team.colorClass}">${team.score}</p>
                    <p class="text-xs text-gray-400">Turns Left: ${team.turnsLeft}</p>
                `;
                scoreboard.appendChild(scoreElement);
            });
        }
        
        /** Shows an error message in the dedicated box. */
        function displayError(message) {
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        /** Randomly selects a category and shuffles its words. */
        function prepareCategoryAndWords() {
            if (typeof wordsByCategory === 'undefined' || Object.keys(wordsByCategory).length === 0) {
                displayError("Word data (words.js) is missing or empty. Please ensure the file is in the same directory and correctly structured.");
                return false;
            }
            document.getElementById('errorBox').classList.add('hidden');

            const categories = Object.keys(wordsByCategory);
            if (categories.length === 0) {
                displayError("words.js is loaded but contains no categories.");
                return false;
            }
            
            const randomCategory = categories[Math.floor(Math.random() * categories.length)];
            
            let words = [...wordsByCategory[randomCategory]];
            // Fisher-Yates shuffle
            for (let i = words.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [words[i], words[j]] = [words[j], words[i]];
            }

            gameState.currentCategory = randomCategory;
            gameState.currentWords = words;
            gameState.currentWordIndex = -1;
            return true;
        }

        /** Displays the next word. */
        function displayNextWord() {
            // Check if we ran out of words for the turn
            if (gameState.currentWordIndex >= gameState.currentWords.length - 1) {
                clearInterval(gameState.timerInterval);
                gameState.timer = 0;
                endTurn();
                return;
            }

            gameState.currentWordIndex++;
            gameState.currentWord = gameState.currentWords[gameState.currentWordIndex];

            document.getElementById('categoryLabel').textContent = `Category: ${gameState.currentCategory}`;
            document.getElementById('currentWordDisplay').textContent = gameState.currentWord.word;
            document.getElementById('hintText').textContent = gameState.currentWord.hint;
            document.getElementById('hintBox').classList.add('hidden');
            document.getElementById('hintsRemainingDisplay').textContent = 2 - gameState.hintsUsedInTurn;
            document.getElementById('hintButton').disabled = (gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintButton').classList.toggle('opacity-50', gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintsRemaining').textContent = 2 - gameState.hintsUsedInTurn;

            updateSkipUI();
        }

        /** Updates the score change text for the Skip button. */
        function updateSkipUI() {
            const scoreChange = gameState.skippedWordsInTurn === 0 ? 0 : -1;
            document.getElementById('skipScoreChange').textContent = scoreChange;
            document.getElementById('skipCounter').textContent = `Skips used this turn: ${gameState.skippedWordsInTurn}`;
        }
        
        // --- Team Setup Functions ---

        /** Dynamically generates name input fields based on the selected count. */
        window.generateTeamNameInputs = function() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            const container = document.getElementById('teamNameInputs');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const color = gameState.teamColorClasses[i];
                const defaultName = `Team ${i + 1}`;
                
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center space-x-2';
                inputWrapper.innerHTML = `
                    <span class="w-4 h-4 rounded-full bg-${color}"></span>
                    <input type="text" id="teamName${i}" placeholder="${defaultName}" value="${defaultName}" class="flex-1 p-3 border-2 border-${color} rounded-xl focus:ring-accent focus:border-accent">
                `;
                container.appendChild(inputWrapper);
            }
        }
        
        /** Captures setup data and initializes the game state. */
        function processSetup() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            gameState.teams = [];

            for (let i = 0; i < count; i++) {
                const inputElement = document.getElementById(`teamName${i}`);
                const name = inputElement.value.trim() || inputElement.placeholder; // Use placeholder if name is empty
                
                gameState.teams.push({
                    name: name,
                    score: 0,
                    turnsLeft: 3, // Each team starts with 3 turns
                    colorClass: gameState.teamColorClasses[i],
                });
            }
            gameState.currentTeamIndex = 0;
            updateScoreDisplay(); // Initialize scoreboard
            prepareNextTurn();
        }


        // --- Game Flow Functions ---

        /** Initializes the setup screen on load. */
        window.initGame = function() {
            generateTeamNameInputs(); // Show 2 team inputs initially
            showScreen('teamSetupScreen');
            document.getElementById('setupStartButton').addEventListener('click', processSetup);
        }

        /** Prepares the turn start screen for the next team. */
        function prepareNextTurn() {
            if (checkGameOver()) {
                showGameOver();
                return;
            }
            
            let currentTeam = gameState.teams[gameState.currentTeamIndex];

            // Cycle through teams until we find one with turns left
            while (currentTeam.turnsLeft === 0) {
                gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
                currentTeam = gameState.teams[gameState.currentTeamIndex];

                // If we cycled back to the start and this team still has 0 turns, game is over
                if (gameState.currentTeamIndex === 0 && currentTeam.turnsLeft === 0) {
                    // Check again just in case, this should already be caught by checkGameOver
                    if (checkGameOver()) { showGameOver(); return; } 
                }
            }

            // Reset turn specific state
            gameState.timer = 30;
            gameState.skippedWordsInTurn = 0;
            gameState.hintsUsedInTurn = 0;
            gameState.currentTurnPoints = 0;
            document.getElementById('timerDisplay').textContent = gameState.timer;
            document.getElementById('timerDisplay').classList.remove('text-red-700'); // Reset timer color

            // Prepare content for the Turn Start Screen
            const teamColor = `text-${currentTeam.colorClass}`;
            const turnNumber = 4 - currentTeam.turnsLeft;

            document.getElementById('turnStartTitle').textContent = `${currentTeam.name}'s Turn ${turnNumber} of 3`;
            document.getElementById('turnStartTitle').className = `text-3xl font-extrabold mb-2 ${teamColor}`;
            document.getElementById('turnStartScreen').style.backgroundColor = `var(--tw-colors-${currentTeam.colorClass}-100)`;
            
            // Pick a category for the turn
            if (prepareCategoryAndWords()) {
                document.getElementById('turnStar
