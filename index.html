<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clue Master: 4-Team Pass & Play</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    // We still define colors here for non-dynamic elements (like hint/skip buttons)
                    colors: {
                        'team1': '#4F46E5', // Indigo (Primary)
                        'team2': '#10B981', // Emerald (Secondary)
                        'team3': '#F59E0B', // Amber
                        'team4': '#EF4444', // Red
                        'accent': '#6366F1', // Indigo-500 for general use
                        'background': '#F9FAFB', // Light Gray
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Load words.js data file. This must be present in the same directory. -->
    <script src="words.js"></script>

    <style>
        /* Custom styles for better mobile appearance */
        body {
            background-color: #F9FAFB;
        }
        .screen-container {
            transition: opacity 0.3s ease-in-out;
        }
        .game-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .game-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .timer-text {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-lg bg-white rounded-2xl shadow-2xl p-6 md:p-8">

        <!-- Header: Dynamic Scoreboard and Timer -->
        <div id="header" class="mb-6">
            <div id="scoreboard" class="grid grid-cols-2 sm:flex sm:justify-around gap-4 mb-4">
                <!-- Scores are populated by JS -->
            </div>
            <div class="text-center p-3 bg-gray-100 rounded-xl shadow-inner">
                <p class="text-xs font-semibold uppercase text-gray-500">Time Left</p>
                <p id="timerDisplay" class="text-4xl font-extrabold text-red-500 timer-text">30</p>
            </div>
        </div>

        <!-- --- Screen Management --- -->

        <!-- 1. Team Setup Screen -->
        <div id="teamSetupScreen" class="screen-container text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Setup Game</h1>
            <p class="text-gray-600 mb-6">Choose your teams and names.</p>
            
            <div class="mb-6 text-left">
                <label for="teamCount" class="block text-sm font-medium text-gray-700 mb-2">Number of Teams:</label>
                <!-- FIX: Removed onchange -->
                <select id="teamCount" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-accent focus:border-accent">
                    <option value="2">2 Teams</option>
                    <option value="3">3 Teams</option>
                    <option value="4">4 Teams</option>
                </select>
            </div>

            <div id="teamNameInputs" class="space-y-4 mb-8">
                <!-- Team name inputs are generated here -->
            </div>

            <button id="setupStartButton" class="w-full game-button bg-team1 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Ready to Play
            </button>
        </div>

        <!-- 2. Turn Start Screen (Transition) -->
        <div id="turnStartScreen" class="screen-container text-center hidden p-8 rounded-xl">
            <h2 id="turnStartTitle" class="text-3xl font-extrabold text-gray-800 mb-2"></h2>
            <p id="turnStartCategory" class="text-lg font-semibold text-gray-800 mb-6"></p>
            <p class="text-gray-600 mb-8">Pass the device to the guesser. Get ready for 30 seconds!</p>
            <!-- FIX: Removed onclick -->
            <button id="turnStartButton" class="w-full game-button bg-team2 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl">
                Start Turn
            </button>
        </div>

        <!-- 3. Game Screen -->
        <div id="gameScreen" class="screen-container text-center hidden">
            <p id="categoryLabel" class="text-sm font-semibold uppercase text-accent mb-4">Category: </p>
            <div class="h-32 flex items-center justify-center mb-6">
                <p id="currentWordDisplay" class="text-5xl font-black text-gray-900 break-words max-w-full">WORD</p>
            </div>

            <div id="hintBox" class="bg-gray-100 p-3 rounded-lg text-gray-600 text-sm italic mb-6 hidden">
                <p id="hintText"></p>
                <p class="text-xs mt-1 text-gray-500">Hint used! (<span id="hintsRemaining">2</span> remaining)</p>
            </div>

            <div class="flex space-x-3 mb-6">
                <!-- FIX: Removed onclick -->
                <button id="hintButton" class="flex-1 game-button bg-team3 hover:bg-amber-600 text-white font-bold py-3 px-2 rounded-xl text-sm md:text-base">
                    Hint (<span id="hintsRemainingDisplay">2</span>)
                </button>
            </div>

            <div class="flex space-x-3">
                <!-- FIX: Removed onclick, added id -->
                <button id="skipButton" class="flex-1 game-button bg-team4 hover:bg-red-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Skip (<span id="skipScoreChange">0</span>)
                </button>
                <!-- FIX: Removed onclick -->
                <button id="correctButton" class="flex-1 game-button bg-team1 hover:bg-indigo-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Correct (+1)
                </button>
            </div>
            <p id="skipCounter" class="text-xs text-gray-500 mt-2">Skips used this turn: 0</p>
        </div>

        <!-- 4. Turn End/Results Screen -->
        <div id="turnEndScreen" class="screen-container text-center hidden">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Turn Over!</h2>
            <p id="turnSummary" class="text-lg text-gray-600 mb-6"></p>
            <p id="nextTurnInfo" class="text-sm font-semibold text-gray-500 mb-8"></p>

            <!-- FIX: Removed onclick -->
            <button id="nextTurnButton" class="w-full game-button bg-accent hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Continue
            </button>
        </div>

        <!-- 5. Game Over Screen -->
        <div id="gameOverScreen" class="screen-container text-center hidden">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-4">Game Over!</h2>
            <p id="winnerMessage" class="text-2xl font-semibold text-team2 mb-6"></p>
            <div id="finalScoreboard" class="flex flex-wrap justify-around mb-8 p-4 bg-gray-100 rounded-lg">
                <!-- Final scores are populated by JS -->
            </div>
            <!-- OK: This onclick is fine as it calls a global browser function -->
            <button onclick="window.location.reload()" class="w-full game-button bg-team4 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl">
                Play Again
            </button>
        </div>

    </div>

    <!-- Error/Alert Box (Replaces alert()) -->
    <div id="errorBox" class="w-full max-w-lg mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-lg hidden">
        <p class="font-bold">Error Loading Game Data:</p>
        <p id="errorMessage"></p>
    </div>

    <!-- JavaScript Game Logic -->
    <script type="module">
        // --- Firebase/Firestore Setup (Boilerplate) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let auth = null;
        let db = null;
        let userId = 'anonymous'; 

        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Custom Auth Failed:", e));
                        } else {
                            signInAnonymously(auth).catch(e => console.error("Anonymous Sign In Failed:", e));
                        }
                    }
                });
                setLogLevel('debug');
            } catch (e) {
                console.warn("Firebase initialization failed:", e.message, "Continuing with local game state.");
            }
        }
        // --- End of Firebase/Firestore Setup ---

        // --- Game State (Refactored for dynamic teams) ---
        let gameState = {
            teams: [], // [{name: '...', score: 0, turnsLeft: 3, colorHex: '...'}, ...]
            teamColorHex: ['#4F46E5', '#10B981', '#F59E0B', '#EF4444'],
            currentTeamIndex: 0, 
            isTurnActive: false,
            timer: 30,
            currentCategory: null,
            currentWords: [],
            currentWordIndex: -1,
            currentWord: null,
            skippedWordsInTurn: 0,
            hintsUsedInTurn: 0,
            timerInterval: null,
            currentTurnPoints: 0,
        };

        // --- Utility Functions ---

        /** Hides all game screens and shows the specified one. */
        function showScreen(screenId) {
            ['teamSetupScreen', 'turnStartScreen', 'gameScreen', 'turnEndScreen', 'gameOverScreen'].forEach(id => {
                const screen = document.getElementById(id);
                if (screen) screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');
        }

        /** Updates the dynamic scoreboard in the header. */
        function updateScoreDisplay() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = ''; // Clear existing scores

            gameState.teams.forEach((team, index) => {
                const isCurrent = index === gameState.currentTeamIndex && gameState.isTurnActive;
                const teamName = team.name || `Team ${index + 1}`; 

                const scoreElement = document.createElement('div');
                scoreElement.className = `text-center p-2 rounded-xl border-2 transition-all duration-300 ${isCurrent ? 'shadow-lg scale-105' : 'bg-gray-50'}`;
                scoreElement.style.borderColor = isCurrent ? team.colorHex : '#F3F4F6'; 

                scoreElement.innerHTML = `
                    <p class="text-xs font-semibold uppercase text-gray-500 truncate">${teamName}</p>
                    <p class="text-xl font-black" style="color: ${team.colorHex};">${team.score}</p>
                    <p class="text-xs text-gray-400">Turns Left: ${team.turnsLeft}</p>
                `;
                scoreboard.appendChild(scoreElement);
            });
        }
        
        /** Shows an error message in the dedicated box. */
        function displayError(message) {
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        /** Randomly selects a category and shuffles its words. */
        function prepareCategoryAndWords() {
            if (typeof wordsByCategory === 'undefined' || Object.keys(wordsByCategory).length === 0) {
                displayError("Word data (words.js) is missing or empty. Please ensure the file is in the same directory and correctly structured.");
                return false;
            }
            document.getElementById('errorBox').classList.add('hidden');

            const categories = Object.keys(wordsByCategory);
            if (categories.length === 0) {
                displayError("words.js is loaded but contains no categories.");
                return false;
            }
            
            const randomCategory = categories[Math.floor(Math.random() * categories.length)];
            
            let words = [...wordsByCategory[randomCategory]];
            for (let i = words.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [words[i], words[j]] = [words[j], words[i]];
            }

            gameState.currentCategory = randomCategory;
            gameState.currentWords = words;
            gameState.currentWordIndex = -1;
            return true;
        }

        /** Displays the next word. */
        function displayNextWord() {
            if (gameState.currentWordIndex >= gameState.currentWords.length - 1) {
                clearInterval(gameState.timerInterval);
                gameState.timer = 0;
                endTurn();
                return;
            }

            gameState.currentWordIndex++;
            gameState.currentWord = gameState.currentWords[gameState.currentWordIndex];

            document.getElementById('categoryLabel').textContent = `Category: ${gameState.currentCategory}`;
            document.getElementById('currentWordDisplay').textContent = gameState.currentWord.word;
            document.getElementById('hintText').textContent = gameState.currentWord.hint;
            document.getElementById('hintBox').classList.add('hidden');
            document.getElementById('hintsRemainingDisplay').textContent = 2 - gameState.hintsUsedInTurn;
            document.getElementById('hintButton').disabled = (gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintButton').classList.toggle('opacity-50', gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintsRemaining').textContent = 2 - gameState.hintsUsedInTurn;

            updateSkipUI();
        }

        /** Updates the score change text for the Skip button. */
        function updateSkipUI() {
            const scoreChange = gameState.skippedWordsInTurn === 0 ? 0 : -1;
            document.getElementById('skipScoreChange').textContent = scoreChange;
            document.getElementById('skipCounter').textContent = `Skips used this turn: ${gameState.skippedWordsInTurn}`;
        }
        
        // --- Team Setup Functions ---

        /** Dynamically generates name input fields based on the selected count. */
        function generateTeamNameInputs() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            const container = document.getElementById('teamNameInputs');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const colorHex = gameState.teamColorHex[i]; 
                const defaultName = `Team ${i + 1}`;
                
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center space-x-2';
                
                inputWrapper.innerHTML = `
                    <span class="w-4 h-4 rounded-full" style="background-color: ${colorHex};"></span>
                    <input type="text" id="teamName${i}" placeholder="${defaultName}" value="${defaultName}" class="flex-1 p-3 border-2 rounded-xl focus:ring-accent" style="border-color: ${colorHex};">
                `;
                container.appendChild(inputWrapper);
            }
        }
        
        /** Captures setup data and initializes the game state. */
        function processSetup() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            gameState.teams = [];

            for (let i = 0; i < count; i++) {
                const inputElement = document.getElementById(`teamName${i}`);
                const name = inputElement.value.trim() || inputElement.placeholder;
                
                gameState.teams.push({
                    name: name,
                    score: 0,
                    turnsLeft: 3, 
                    colorHex: gameState.teamColorHex[i], 
                });
            }
            gameState.currentTeamIndex = 0;
            updateScoreDisplay(); 
            prepareNextTurn();
        }


        // --- Game Flow Functions ---

        /** Prepares the turn start screen for the next team. */
        function prepareNextTurn() {
            if (checkGameOver()) {
                showGameOver();
                return;
            }
            
            let currentTeam = gameState.teams[gameState.currentTeamIndex];
            let cycleCount = 0;
            while (currentTeam.turnsLeft === 0 && cycleCount < gameState.teams.length) {
                gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
                currentTeam = gameState.teams[gameState.currentTeamIndex];
                cycleCount++;
            }
            
            if (cycleCount >= gameState.teams.length) {
                if (checkGameOver()) { showGameOver(); return; }
            }

            gameState.timer = 30;
            gameState.skippedWordsInTurn = 0;
            gameState.hintsUsedInTurn = 0;
            gameState.currentTurnPoints = 0;
            document.getElementById('timerDisplay').textContent = gameState.timer;
            document.getElementById('timerDisplay').classList.remove('text-red-700'); 

            const turnNumber = 4 - currentTeam.turnsLeft;
            const titleElement = document.getElementById('turnStartTitle');
            titleElement.textContent = `${currentTeam.name}'s Turn ${turnNumber} of 3`;
            titleElement.style.color = currentTeam.colorHex;

            const turnScreen = document.getElementById('turnStartScreen');
            turnScreen.style.backgroundColor = `${currentTeam.colorHex}1A`; 
            
            if (prepareCategoryAndWords()) {
                document.getElementById('turnStartCategory').textContent = `Category: ${gameState.currentCategory}`;
                showScreen('turnStartScreen');
            }
            updateScoreDisplay(); 
        }

        /** Starts the 30-second timer and moves to the game screen. */
        function startTimer() {
            gameState.isTurnActive = true;
            showScreen('gameScreen');
            
            const currentTeam = gameState.teams[gameState.currentTeamIndex];
            const correctButton = document.getElementById("correctButton");
            
            correctButton.style.backgroundColor = currentTeam.colorHex;
            correctButton.onmouseover = () => { correctButton.style.opacity = '0.8'; };
            correctButton.onmouseout = () => { correctButton.style.opacity = '1'; };

            displayNextWord();

            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                document.getElementById('timerDisplay').textContent = gameState.timer;
                
                // Change timer color when below 10 seconds
                if (gameState.timer <= 10) {
                    document.getElementById('timerDisplay').classList.add('text-red-700');
                }

                if (gameState.timer <= 0) {
                    clearInterval(gameState.timerInterval);
                    endTurn();
                }
            }, 1000);
            
            updateScoreDisplay();
        }

        /** Ends the current turn and shows the results. */
        function endTurn() {
            gameState.isTurnActive = false;
            clearInterval(gameState.timerInterval);
            
            const currentTeam = gameState.teams[gameState.currentTeamIndex];
            
            // Apply score penalties for skips
            if (gameState.skippedWordsInTurn > 0) {
                currentTeam.score = Math.max(0, currentTeam.score - 1);
            }
            
            currentTeam.turnsLeft--;
            
            // Show turn summary
            document.getElementById('turnSummary').textContent = 
                `${currentTeam.name} scored ${gameState.currentTurnPoints} point${gameState.currentTurnPoints === 1 ? '' : 's'}!`;
            
            // Determine next team
            gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
            
            const nextTeam = gameState.teams[gameState.currentTeamIndex];
            document.getElementById('nextTurnInfo').textContent = 
                `Next up: ${nextTeam.name}`;
            
            updateScoreDisplay();
            showScreen('turnEndScreen');
        }

        /** Handles the "Correct" button click. */
        function handleCorrectAnswer() {
            if (!gameState.isTurnActive) return;
            
            const currentTeam = gameState.teams[gameState.currentTeamIndex];
            currentTeam.score++;
            gameState.currentTurnPoints++;
            updateScoreDisplay();
            displayNextWord();
        }

        /** Handles the "Skip" button click. */
        function handleSkip() {
            if (!gameState.isTurnActive) return;
            
            gameState.skippedWordsInTurn++;
            updateSkipUI();
            displayNextWord();
        }

        /** Handles the "Hint" button click. */
        function handleHint() {
            if (!gameState.isTurnActive || gameState.hintsUsedInTurn >= 2) return;
            
            gameState.hintsUsedInTurn++;
            document.getElementById('hintBox').classList.remove('hidden');
            document.getElementById('hintsRemainingDisplay').textContent = 2 - gameState.hintsUsedInTurn;
            document.getElementById('hintButton').disabled = (gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintButton').classList.toggle('opacity-50', gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintsRemaining').textContent = 2 - gameState.hintsUsedInTurn;
        }

        /** Checks if the game is over (all teams have no turns left). */
        function checkGameOver() {
            return gameState.teams.every(team => team.turnsLeft === 0);
        }

        /** Displays the game over screen with winners. */
        function showGameOver() {
            const maxScore = Math.max(...gameState.teams.map(t => t.score));
            const winners = gameState.teams.filter(t => t.score === maxScore);
            
            let winnerText = '';
            if (winners.length === 1) {
                winnerText = `${winners[0].name} wins!`;
            } else {
                const winnerNames = winners.map(t => t.name).join(' and ');
                winnerText = `It's a tie between ${winnerNames}!`;
            }
            
            document.getElementById('winnerMessage').textContent = winnerText;
            
            // Build final scoreboard
            const finalScoreboard = document.getElementById('finalScoreboard');
            finalScoreboard.innerHTML = '';
            
            // Sort teams by score (descending)
            const sortedTeams = [...gameState.teams].sort((a, b) => b.score - a.score);
            
            sortedTeams.forEach(team => {
                const teamElement = document.createElement('div');
                teamElement.className = 'text-center m-2';
                teamElement.innerHTML = `
                    <p class="font-bold text-lg" style="color: ${team.colorHex};">${team.name}</p>
                    <p class="text-2xl font-black" style="color: ${team.colorHex};">${team.score}</p>
                `;
                finalScoreboard.appendChild(teamElement);
            });
            
            showScreen('gameOverScreen');
        }

        // --- Initialize Game ---
        
        /** Initialize the game when the page loads. */
        function initGame() {
            // Generate initial team name inputs (for 2 teams by default)
            generateTeamNameInputs();
            
            // Attach event listeners to buttons
            
            // Team setup screen
            document.getElementById('teamCount').addEventListener('change', generateTeamNameInputs);
            document.getElementById('setupStartButton').addEventListener('click', processSetup);
            
            // Turn start screen
            document.getElementById('turnStartButton').addEventListener('click', startTimer);
            
            // Game screen buttons
            document.getElementById('correctButton').addEventListener('click', handleCorrectAnswer);
            document.getElementById('skipButton').addEventListener('click', handleSkip);
            document.getElementById('hintButton').addEventListener('click', handleHint);
            
            // Turn end screen
            document.getElementById('nextTurnButton').addEventListener('click', prepareNextTurn);
            
            // Show the team setup screen first
            showScreen('teamSetupScreen');
        }

        // Start the game when the page loads
        window.addEventListener('DOMContentLoaded', initGame);
        
    </script>
</body>
</html>
