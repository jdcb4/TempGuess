 
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clue Master: 4-Team Pass & Play</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors and font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'team1': '#4F46E5', // Indigo (Primary)
                        'team2': '#10B981', // Emerald (Secondary)
                        'team3': '#F59E0B', // Amber
                        'team4': '#EF4444', // Red
                        'accent': '#6366F1', // Indigo-500 for general use
                        'background': '#F9FAFB', // Light Gray
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <!-- Load words.js data file. This must be present in the same directory. -->
    <script src="words.js"></script>

    <style>
        /* Custom styles for better mobile appearance */
        body {
            background-color: #F9FAFB;
        }
        .screen-container {
            transition: opacity 0.3s ease-in-out;
        }
        .game-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .game-button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .timer-text {
            font-variant-numeric: tabular-nums;
        }
        /* Explicitly define border colors for the dynamic scoreboard */
        .team-color-border-team1 { border-color: #4F46E5; }
        .team-color-border-team2 { border-color: #10B981; }
        .team-color-border-team3 { border-color: #F59E0B; }
        .team-color-border-team4 { border-color: #EF4444; }
    </style>
</head>
<body class="font-sans min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100">

    <!-- Tailwind Fix: Explicitly include dynamic classes so the JIT compiler generates them on load -->
    <div class="hidden">
        <span class="bg-team1 border-team1 text-team1 bg-team1/10"></span>
        <span class="bg-team2 border-team2 text-team2 bg-team2/10"></span>
        <span class="bg-team3 border-team3 text-team3 bg-team3/10"></span>
        <span class="bg-team4 border-team4 text-team4 bg-team4/10"></span>
    </div>
    <!-- End of Tailwind Fix -->

    <!-- Game Container -->
    <div id="game-container" class="w-full max-w-lg bg-white rounded-2xl shadow-2xl p-6 md:p-8">

        <!-- Header: Dynamic Scoreboard and Timer -->
        <div id="header" class="mb-6">
            <div id="scoreboard" class="grid grid-cols-2 sm:flex sm:justify-around gap-4 mb-4">
                <!-- Scores are populated by JS -->
            </div>
            <div class="text-center p-3 bg-gray-100 rounded-xl shadow-inner">
                <p class="text-xs font-semibold uppercase text-gray-500">Time Left</p>
                <p id="timerDisplay" class="text-4xl font-extrabold text-red-500 timer-text">30</p>
            </div>
        </div>

        <!-- --- Screen Management --- -->

        <!-- 1. Team Setup Screen -->
        <div id="teamSetupScreen" class="screen-container text-center">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Setup Game</h1>
            <p class="text-gray-600 mb-6">Choose your teams and names.</p>
            
            <div class="mb-6 text-left">
                <label for="teamCount" class="block text-sm font-medium text-gray-700 mb-2">Number of Teams:</label>
                <select id="teamCount" onchange="generateTeamNameInputs()" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-accent focus:border-accent">
                    <option value="2">2 Teams</option>
                    <option value="3">3 Teams</option>
                    <option value="4">4 Teams</option>
                </select>
            </div>

            <div id="teamNameInputs" class="space-y-4 mb-8">
                <!-- Team name inputs are generated here -->
            </div>

            <button id="setupStartButton" class="w-full game-button bg-primary hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Ready to Play
            </button>
        </div>

        <!-- 2. Turn Start Screen (Transition) -->
        <div id="turnStartScreen" class="screen-container text-center hidden p-8 rounded-xl">
            <h2 id="turnStartTitle" class="text-3xl font-extrabold text-gray-800 mb-2"></h2>
            <p id="turnStartCategory" class="text-lg font-semibold text-gray-800 mb-6"></p>
            <p class="text-gray-600 mb-8">Pass the device to the guesser. Get ready for 30 seconds!</p>
            <button onclick="startTimer()" class="w-full game-button bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-xl">
                Start Turn
            </button>
        </div>

        <!-- 3. Game Screen -->
        <div id="gameScreen" class="screen-container text-center hidden">
            <p id="categoryLabel" class="text-sm font-semibold uppercase text-accent mb-4">Category: </p>
            <div class="h-32 flex items-center justify-center mb-6">
                <p id="currentWordDisplay" class="text-5xl font-black text-gray-900 break-words max-w-full">WORD</p>
            </div>

            <div id="hintBox" class="bg-gray-100 p-3 rounded-lg text-gray-600 text-sm italic mb-6 hidden">
                <p id="hintText"></p>
                <p class="text-xs mt-1 text-gray-500">Hint used! (<span id="hintsRemaining">2</span> remaining)</p>
            </div>

            <div class="flex space-x-3 mb-6">
                <button id="hintButton" onclick="showHint()" class="flex-1 game-button bg-team3 hover:bg-amber-600 text-white font-bold py-3 px-2 rounded-xl text-sm md:text-base">
                    Hint (<span id="hintsRemainingDisplay">2</span>)
                </button>
            </div>

            <div class="flex space-x-3">
                <button onclick="handleAction('skip')" class="flex-1 game-button bg-team4 hover:bg-red-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Skip (<span id="skipScoreChange">0</span>)
                </button>
                <button id="correctButton" onclick="handleAction('correct')" class="flex-1 game-button bg-primary hover:bg-indigo-600 text-white font-bold py-4 px-2 rounded-xl text-lg">
                    Correct (+1)
                </button>
            </div>
            <p id="skipCounter" class="text-xs text-gray-500 mt-2">Skips used this turn: 0</p>
        </div>

        <!-- 4. Turn End/Results Screen -->
        <div id="turnEndScreen" class="screen-container text-center hidden">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-4">Turn Over!</h2>
            <p id="turnSummary" class="text-lg text-gray-600 mb-6"></p>
            <p id="nextTurnInfo" class="text-sm font-semibold text-gray-500 mb-8"></p>

            <button onclick="nextTurn()" class="w-full game-button bg-accent hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl">
                Continue
            </button>
        </div>

        <!-- 5. Game Over Screen -->
        <div id="gameOverScreen" class="screen-container text-center hidden">
            <h2 class="text-4xl font-extrabold text-gray-800 mb-4">Game Over!</h2>
            <p id="winnerMessage" class="text-2xl font-semibold text-secondary mb-6"></p>
            <div id="finalScoreboard" class="flex flex-wrap justify-around mb-8 p-4 bg-gray-100 rounded-lg">
                <!-- Final scores are populated by JS -->
            </div>
            <button onclick="window.location.reload()" class="w-full game-button bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl">
                Play Again
            </button>
        </div>

    </div>

    <!-- Error/Alert Box (Replaces alert()) -->
    <div id="errorBox" class="w-full max-w-lg mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-xl shadow-lg hidden">
        <p class="font-bold">Error Loading Game Data:</p>
        <p id="errorMessage"></p>
    </div>

    <!-- JavaScript Game Logic -->
    <script type="module">
        // --- Firebase/Firestore Setup (Boilerplate) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let auth = null;
        let db = null;
        let userId = 'anonymous'; 

        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            signInWithCustomToken(auth, __initial_auth_token).catch(e => console.error("Custom Auth Failed:", e));
                        } else {
                            signInAnonymously(auth).catch(e => console.error("Anonymous Sign In Failed:", e));
                        }
                    }
                });
                setLogLevel('debug');
            } catch (e) {
                console.warn("Firebase initialization failed:", e.message, "Continuing with local game state.");
            }
        }
        // --- End of Firebase/Firestore Setup ---

        // --- Game State (Refactored for dynamic teams) ---
        let gameState = {
            teams: [], // [{name: '...', score: 0, turnsLeft: 3, colorClass: '...'}, ...]
            teamColorClasses: ['team1', 'team2', 'team3', 'team4'],
            currentTeamIndex: 0, 
            isTurnActive: false,
            timer: 30,
            currentCategory: null,
            currentWords: [],
            currentWordIndex: -1,
            currentWord: null,
            skippedWordsInTurn: 0,
            hintsUsedInTurn: 0,
            timerInterval: null,
            currentTurnPoints: 0,
        };

        // --- Utility Functions ---

        /** Hides all game screens and shows the specified one. */
        function showScreen(screenId) {
            ['teamSetupScreen', 'turnStartScreen', 'gameScreen', 'turnEndScreen', 'gameOverScreen'].forEach(id => {
                const screen = document.getElementById(id);
                if (screen) screen.classList.add('hidden');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) targetScreen.classList.remove('hidden');
        }

        /** Updates the dynamic scoreboard in the header. */
        function updateScoreDisplay() {
            const scoreboard = document.getElementById('scoreboard');
            scoreboard.innerHTML = ''; // Clear existing scores

            gameState.teams.forEach((team, index) => {
                const isCurrent = index === gameState.currentTeamIndex && gameState.isTurnActive;
                
                const scoreElement = document.createElement('div');
                scoreElement.className = `text-center p-2 rounded-xl border-2 transition-all duration-300 ${isCurrent ? 'shadow-lg scale-105' : 'bg-gray-50 border-gray-100'} team-color-border-${team.colorClass}`;
                
                const teamName = team.name || `Team ${index + 1}`; 

                scoreElement.innerHTML = `
                    <p class="text-xs font-semibold uppercase text-gray-500 truncate">${teamName}</p>
                    <p class="text-xl font-black text-${team.colorClass}">${team.score}</p>
                    <p class="text-xs text-gray-400">Turns Left: ${team.turnsLeft}</p>
                `;
                scoreboard.appendChild(scoreElement);
            });
        }
        
        /** Shows an error message in the dedicated box. */
        function displayError(message) {
            document.getElementById('errorBox').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }
        
        /** Randomly selects a category and shuffles its words. */
        function prepareCategoryAndWords() {
            // Check for wordsByCategory which is loaded from words.js
            if (typeof wordsByCategory === 'undefined' || Object.keys(wordsByCategory).length === 0) {
                displayError("Word data (words.js) is missing or empty. Please ensure the file is in the same directory and correctly structured.");
                return false;
            }
            document.getElementById('errorBox').classList.add('hidden');

            const categories = Object.keys(wordsByCategory);
            if (categories.length === 0) {
                displayError("words.js is loaded but contains no categories.");
                return false;
            }
            
            const randomCategory = categories[Math.floor(Math.random() * categories.length)];
            
            let words = [...wordsByCategory[randomCategory]];
            // Fisher-Yates shuffle
            for (let i = words.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [words[i], words[j]] = [words[j], words[i]];
            }

            gameState.currentCategory = randomCategory;
            gameState.currentWords = words;
            gameState.currentWordIndex = -1;
            return true;
        }

        /** Displays the next word. */
        function displayNextWord() {
            // Check if we ran out of words for the turn
            if (gameState.currentWordIndex >= gameState.currentWords.length - 1) {
                clearInterval(gameState.timerInterval);
                gameState.timer = 0;
                endTurn();
                return;
            }

            gameState.currentWordIndex++;
            gameState.currentWord = gameState.currentWords[gameState.currentWordIndex];

            document.getElementById('categoryLabel').textContent = `Category: ${gameState.currentCategory}`;
            document.getElementById('currentWordDisplay').textContent = gameState.currentWord.word;
            document.getElementById('hintText').textContent = gameState.currentWord.hint;
            document.getElementById('hintBox').classList.add('hidden');
            document.getElementById('hintsRemainingDisplay').textContent = 2 - gameState.hintsUsedInTurn;
            document.getElementById('hintButton').disabled = (gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintButton').classList.toggle('opacity-50', gameState.hintsUsedInTurn >= 2);
            document.getElementById('hintsRemaining').textContent = 2 - gameState.hintsUsedInTurn;

            updateSkipUI();
        }

        /** Updates the score change text for the Skip button. */
        function updateSkipUI() {
            const scoreChange = gameState.skippedWordsInTurn === 0 ? 0 : -1;
            document.getElementById('skipScoreChange').textContent = scoreChange;
            document.getElementById('skipCounter').textContent = `Skips used this turn: ${gameState.skippedWordsInTurn}`;
        }
        
        // --- Team Setup Functions ---

        /** Dynamically generates name input fields based on the selected count. */
        window.generateTeamNameInputs = function() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            const container = document.getElementById('teamNameInputs');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const color = gameState.teamColorClasses[i];
                const defaultName = `Team ${i + 1}`;
                
                const inputWrapper = document.createElement('div');
                inputWrapper.className = 'flex items-center space-x-2';
                // Note: The classes bg-${color} and border-${color} are now statically included in the hidden div above.
                inputWrapper.innerHTML = `
                    <span class="w-4 h-4 rounded-full bg-${color}"></span>
                    <input type="text" id="teamName${i}" placeholder="${defaultName}" value="${defaultName}" class="flex-1 p-3 border-2 border-${color} rounded-xl focus:ring-accent focus:border-accent">
                `;
                container.appendChild(inputWrapper);
            }
        }
        
        /** Captures setup data and initializes the game state. */
        function processSetup() {
            const count = parseInt(document.getElementById('teamCount').value, 10);
            gameState.teams = [];

            for (let i = 0; i < count; i++) {
                const inputElement = document.getElementById(`teamName${i}`);
                const name = inputElement.value.trim() || inputElement.placeholder;
                
                gameState.teams.push({
                    name: name,
                    score: 0,
                    turnsLeft: 3, 
                    colorClass: gameState.teamColorClasses[i],
                });
            }
            gameState.currentTeamIndex = 0;
            updateScoreDisplay(); 
            prepareNextTurn();
        }


        // --- Game Flow Functions ---

        /** Initializes the setup screen on load. */
        window.initGame = function() {
            generateTeamNameInputs(); // Show 2 team inputs initially
            showScreen('teamSetupScreen');
            // Attach listener to start button
            const startButton = document.getElementById('setupStartButton');
            if (startButton) {
                startButton.addEventListener('click', processSetup);
            }
        }

        /** Prepares the turn start screen for the next team. */
        function prepareNextTurn() {
            if (checkGameOver()) {
                showGameOver();
                return;
            }
            
            let currentTeam = gameState.teams[gameState.currentTeamIndex];

            // Cycle through teams until we find one with turns left
            let cycleCount = 0;
            while (currentTeam.turnsLeft === 0 && cycleCount < gameState.teams.length) {
                gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
                currentTeam = gameState.teams[gameState.currentTeamIndex];
                cycleCount++;
            }
            
            // If all teams have 0 turns left, end the game (this is a fallback check)
            if (cycleCount >= gameState.teams.length) {
                if (checkGameOver()) { showGameOver(); return; }
            }

            // Reset turn specific state
            gameState.timer = 30;
            gameState.skippedWordsInTurn = 0;
            gameState.hintsUsedInTurn = 0;
            gameState.currentTurnPoints = 0;
            document.getElementById('timerDisplay').textContent = gameState.timer;
            document.getElementById('timerDisplay').classList.remove('text-red-700'); 

            // Prepare content for the Turn Start Screen
            const teamColorClass = `text-${currentTeam.colorClass}`;
            const teamBgClass = `bg-${currentTeam.colorClass}/10`;
            const turnNumber = 4 - currentTeam.turnsLeft;

            document.getElementById('turnStartTitle').textContent = `${currentTeam.name}'s Turn ${turnNumber} of 3`;
            document.getElementById('turnStartTitle').className = `text-3xl font-extrabold mb-2 ${teamColorClass}`;

            // Robustly apply background class for the turn start screen
            document.getElementById('turnStartScreen').classList.remove('bg-team1/10', 'bg-team2/10', 'bg-team3/10', 'bg-team4/10');
            document.getElementById('turnStartScreen').classList.add(teamBgClass);
            
            // Pick a category for the turn
            if (prepareCategoryAndWords()) {
                document.getElementById('turnStartCategory').textContent = `Category: ${gameState.currentCategory}`;
                showScreen('turnStartScreen');
            }
            updateScoreDisplay(); 
        }

        /** Starts the 30-second timer and moves to the game screen. */
        window.startTimer = function() {
            gameState.isTurnActive = true;
            showScreen('gameScreen');
            
            const currentTeam = gameState.teams[gameState.currentTeamIndex];
            const correctButton = document.getElementById("correctButton");
            
            // Set correct button color dynamically
            correctButton.classList.remove('bg-team1', 'bg-team2', 'bg-team3', 'bg-team4', 'hover:bg-indigo-600', 'hover:bg-emerald-600', 'hover:bg-amber-600', 'hover:bg-red-600');
            correctButton.classList.add(`bg-${currentTeam.colorClass}`);

            displayNextWord();

            gameState.timerInterval = setInterval(() => {
                gameState.timer--;
                document.getElementById('timerDisplay').textContent = gameState.timer;
                
                if (gameState.timer <= 10) {
                     document.getElementById('timerDisplay').classList.remove('text-red-500');
                     document.getElementById('timerDisplay').classList.add('text-red-700');
                }

                if (gameState.timer <= 0) {
                    endTurn();
                }
            }, 1000);
        }

        /** Handles Correct or Skip actions. */
        window.handleAction = function(action) {
            if (!gameState.isTurnActive || gameState.timer <= 0) return;

            if (action === 'correct') {
                gameState.currentTurnPoints += 1;
            } else if (action === 'skip') {
                if (gameState.skippedWordsInTurn > 0) {
                    // Subsequent skips: -1 point change
                    gameState.currentTurnPoints -= 1;
                }
                gameState.skippedWordsInTurn++;
                updateSkipUI();
            }

            displayNextWord();
        }

        /** Shows the hint for the current word. */
        window.showHint = function() {
            if (!gameState.isTurnActive || gameState.hintsUsedInTurn >= 2) return;
            
            gameState.hintsUsedInTurn++;
            document.getElementById('hintBox').classList.remove('hidden');
            document.getElementById('hintsRemainingDisplay').textContent = 2 - gameState.hintsUsedInTurn;
            
            if (gameState.hintsUsedInTurn >= 2) {
                document.getElementById('hintButton').disabled = true;
                document.getElementById('hintButton').classList.add('opacity-50');
            }
        }

        /** Ends the current turn, calculates score, and moves to the end screen. */
        function endTurn() {
            if (!gameState.isTurnActive) return;

            clearInterval(gameState.timerInterval);
            gameState.isTurnActive = false;
            
            let currentTeam = gameState.teams[gameState.currentTeamIndex];

            // Apply turn points to the current team's total score
            currentTeam.score += gameState.currentTurnPoints;
            currentTeam.turnsLeft--;
            
            updateScoreDisplay();

            // Prepare the Turn End Screen
            document.getElementById('turnSummary').textContent = `${currentTeam.name} scored ${gameState.currentTurnPoints} point${gameState.currentTurnPoints !== 1 ? 's' : ''} this turn!`;
            
            if (checkGameOver()) {
                document.getElementById('nextTurnInfo').textContent = "That was the last turn! Let's see the final scores.";
            } else {
                let foundNextTeam = false;
                let nextTeamName = "Next Team";
                for (let i = 0; i < gameState.teams.length; i++) {
                    const index = (gameState.currentTeamIndex + 1 + i) % gameState.teams.length;
                    if (gameState.teams[index].turnsLeft > 0) {
                        nextTeamName = gameState.teams[index].name;
                        foundNextTeam = true;
                        break;
                    }
                }
                
                if (foundNextTeam) {
                    document.getElementById('nextTurnInfo').textContent = `${nextTeamName}, get ready for your turn.`;
                } else {
                    document.getElementById('nextTurnInfo').textContent = "All turns are complete. Proceed to results.";
                }
            }
            
            // Advance to the next team index for the next turn setup
            gameState.currentTeamIndex = (gameState.currentTeamIndex + 1) % gameState.teams.length;
            
            showScreen('turnEndScreen');
        }

        /** Moves to the next team's turn setup. */
        window.nextTurn = function() {
            prepareNextTurn();
        }

        /** Checks if the game is completely over (all teams have 0 turns left). */
        function checkGameOver() {
            return gameState.teams.length > 0 && gameState.teams.every(team => team.turnsLeft <= 0);
        }

        /** Shows the final game over screen with the winner. */
        function showGameOver() {
            let maxScore = -Infinity;
            let winners = [];

            // Determine winner(s)
            gameState.teams.forEach(team => {
                if (team.score > maxScore) {
                    maxScore = team.score;
                    winners = [team];
                } else if (team.score === maxScore) {
                    winners.push(team);
                }
            });
            
            // Prepare winner message
            let winnerMsg;
            if (winners.length === 1) {
                winnerMsg = `${winners[0].name} Wins with ${maxScore} Points!`;
            } else {
                const names = winners.map(w => w.name).join(' and ');
                winnerMsg = `It's a Tie! Winners: ${names}`;
            }
            
            document.getElementById('winnerMessage').textContent = winnerMsg;
            
            // Populate final scoreboard
            const finalScoreboard = document.getElementById('finalScoreboard');
            finalScoreboard.innerHTML = '';
            gameState.teams.forEach(team => {
                const isWinner = team.score === maxScore && maxScore > 0;
                const scoreElement = document.createElement('p');
                scoreElement.className = `text-lg font-medium p-2 rounded-lg ${isWinner ? `text-white bg-${team.colorClass} font-bold shadow-md` : 'text-gray-700'}`;
                scoreElement.innerHTML = `${team.name}: <span class="font-bold">${team.score}</span>`;
                finalScoreboard.appendChild(scoreElement);
            });

            showScreen('gameOverScreen');
        }

        // --- Initialization ---
        window.onload = initGame;
    </script>
</body>
</html>

